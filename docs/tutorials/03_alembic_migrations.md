# Use Alembic with MolAlchemy

The [Alembic](https://alembic.sqlalchemy.org/en/latest/) library is a lightweight database migration tool for usage with the SQLAlchemy Database Toolkit for Python. `molalchemy` provides custom types that need special handling during Alembic's autogeneration of migration scripts.

Having model defined like this:

```python
from molalchemy.rdkit import index, types
import sqlalchemy as sa
from sqlalchemy.orm import (
    DeclarativeBase,
    Mapped,
    MappedAsDataclass,
    mapped_column,
)

class Base(MappedAsDataclass, DeclarativeBase):
    pass
class Molecule(Base):
    __tablename__ = "molecules"
    __table_args__ = (
        index.RdkitIndex("idx_molecules_mol", "mol"),
    )
    id: Mapped[int] = mapped_column(sa.Integer, primary_key=True)
    mol: Mapped[bytes] = mapped_column(types.RdkitMol(return_type="bytes"))

```

Creating an Alembic migration with `alembic revision --autogenerate -m "create mol table"` will generate something like this:

```python
"""add mol table

Revision ID: ...
Revises: 
Create Date: ...

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = ...
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('molecules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('mol', molalchemy.rdkit.types.RdkitMol(return_type='bytes'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_molecules_mol', 'molecules', ['mol'], unique=False, postgresql_using='gist')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('idx_molecules_mol', table_name='molecules', postgresql_using='gist')
    op.drop_table('molecules')
    # ### end Alembic commands ###

```

This looks mostly correct, but the molalchemy types are not properly imported, which will lead to errors when trying to run the migration. You can manually fix the imports, or use the following method to automate this.
To add proper import statements for `molalchemy` types during Alembic's autogeneration process, you can use the `molalchemy.alembic_helpers` module to customize how different items are rendered in the generated migration scripts.
To set this up, modify your `alembic_folder_name/env.py` file to include the custom rendering function.

```python
from molalchemy import alembic_helpers

def run_migrations_offline():
    # ...
    context.configure(
        # ...
        render_item=alembic_helpers.render_item,
    )
    # ...


def run_migrations_online():
    # ...
    context.configure(
        # ...
        render_item=alembic_helpers.render_item,
    )
    # ...
```

This will ensure that when Alembic generates migration scripts, it will include the necessary import statements for `molalchemy` types, allowing the migrations to run without import errors.